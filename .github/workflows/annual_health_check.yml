name: Annual Python Health Check
on:
  schedule:
    - cron: '0 0 1 3 *'  # 00:00 on March 1st
  workflow_dispatch:      # Allows you to test it manually

jobs:
  check-versions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          version: "latest"

      - name: Install Task
        uses: go-task/setup-task@v1

      - name: Run CI Suite
        # This ensures the code still works with the CURRENT locked version
        run: uv run task ci:full-suite

### Approach 1:

      - name: Check for New Python Version
        id: check_version # https://devguide.python.org/versions/
        run: |
          # Simple check to see if a newer minor version exists
          CURRENT=$(uv python list --installed | grep -oP '3\.\d+' | head -1)
          LATEST=$(uv python list --available | grep -oP '3\.\d+' | sort -V | tail -1)
          echo "Current: $CURRENT, Latest: $LATEST"
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "upgrade_found=true" >> $GITHUB_OUTPUT
          fi

      - name: Notify if Fail or Upgrade Available
        if: failure() || steps.check_version.outputs.upgrade_found == 'true'
        run: |
          # This triggers a GitHub Notification/Email to the repo owner
          echo "::error::Maintenance check failed or new Python version found!"
          exit 1

### Approach 2:

      - name: Determine Target Python Version
        id: target
        shell: python
        run: |
          import datetime, os
          # Logic: Target minor version corresponds to (Current Year - 2).
          # Mapping years to Python 3.x (3.2 -> 2011) gives: minor = (year - 2) - 2011 == year - 2013.
          target_minor = datetime.date.today().year - 2013 
          version = f"3.{target_minor}"
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"version={version}\n")

      - name: Run CI on Target Version
        run: |
          uv python install ${{ steps.target.outputs.version }}
          uv run --python ${{ steps.target.outputs.version }} task ci:full-suite

      # - name: Send Status Email
      #   if: always()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 465
      #     username: ${{ secrets.MAIL_USERNAME }}
      #     password: ${{ secrets.MAIL_PASSWORD }}
      #     subject: "Annual CI Report: Python ${{ steps.target.outputs.version }}"
      #     body: "The annual check for Python ${{ steps.target.outputs.version }} completed with status: ${{ job.status }}. View results: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      #     to: your-email@example.com